<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Factory - Literate EVM Dev</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="../UniswapV1/index.html"><strong aria-hidden="true">2.</strong> Uniswap v1 - Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../UniswapV1/factory.html" class="active"><strong aria-hidden="true">2.1.</strong> Factory</a></li><li class="chapter-item expanded "><a href="../UniswapV1/exchange.html"><strong aria-hidden="true">2.2.</strong> Exchange</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Literate EVM Dev</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="factory"><a class="header" href="#factory">Factory</a></h1>
<p>Uniswap v1 Factory (<a href="https://github.com/Uniswap/v1-contracts/blob/master/contracts/uniswap_factory.vy">Github</a>)</p>
<p>NB: Uniswap v1 Factory was compiled and deployed (<a href="https://etherscan.io/address/0xc0a47dFe034B400B47bDaD5FecDa2621de6c4d95">Etherscan.io</a>, <a href="https://etherscan.io/tx/0xc1b2646d0ad4a3a151ebdaaa7ef72e3ab1aa13aa49d0b7a3ca020f5ee7b1b010">tx</a>) using Vyper <a href="https://vyper.readthedocs.io/en/v0.1.0-beta.4/">v0.1.0b4</a>, which is <em>old</em>, no matter how you slice it. Consequently, the syntax of the language used at the time differs considerably from what you’ll see in the later versions of Vyper.</p>
<pre><code class="language-python">contract Exchange():
    def setup(token_addr: address): modifying
</code></pre>
<p>Prior to Vyper v0.2.1, which was a major breaking release<sup class="footnote-reference"><a href="#vyper">1</a></sup>, Vyper contracts used the keyword <code>contract</code> to declare interfaces for interacting with other contracts, instead of the now more familiar <code>interface</code>.</p>
<p>Factory uses the <code>setup</code> function of each deployed Exchange contract to configure the ERC20 asset. <code>setup</code> takes a single argument, which is the address of the ERC20 token. <code>setup</code> doesn’t return any values, and it will modify the state of the Exchange instance.</p>
<pre><code class="language-python">NewExchange: event({token: indexed(address), exchange: indexed(address)})
</code></pre>
<p>Factory emits the <code>NewExchange</code> event<sup class="footnote-reference"><a href="#events">2</a></sup> every time an Exchange is created; this is consistent with the practice of informing off-chain dApp counterparts about important state changes of the on-chain system. <code>NewExchange</code> records two pieces of information: the address of the ERC20 token in the pair (<code>token</code>) and the address of the Exchange contract deployed for the pair (<code>exchange</code>.) </p>
<pre><code class="language-python">exchangeTemplate: public(address)
tokenCount: public(uint256)
token_to_exchange: address[address]
exchange_to_token: address[address]
id_to_token: address[uint256]
</code></pre>
<p>State variables<sup class="footnote-reference"><a href="#statevars">3</a></sup> are declared next. </p>
<p><code>exchangeTemplate</code> is a public<sup class="footnote-reference"><a href="#public">4</a></sup> variable that stores the address<sup class="footnote-reference"><a href="#address">5</a></sup> of the Exchange contract deployed during Factory initialization. This “on-chain template” is used by Factory to deploy Exchanges at run-time by deploying a minimal proxy using the code of the contract already deployed for its logic.</p>
<p><code>tokenCount</code> is a public variable the stores the number of ERC20 tokens for which Exchanges have been deployed. </p>
<p><code>token_to_exchange</code> is a mapping to resolve ERC20 token addresses to Exchange addresses.</p>
<p><code>exchange_to_token</code> is a mapping to resolve Exchange addresses to ERC20 token addresses.</p>
<p><code>id_to_token</code> is a mapping to resolve ERC20 token identities (serial numbers as defined by the <code>tokenCount</code> counter) to ERC20 token addresses.</p>
<p>NOTE. Mapping declarations of the form <code>_valueType[_keyType]</code> follow the syntax of the Vyper version used (<code>0.1.0b4</code>), but also <code>0.1.0b4</code> will error when compiling Uniswap v1 code. Same goes for <a href="./exchange.html">Exchange</a>, and I have been unable to solve this mystery so far. Please let me know if <em>you</em> know what’s up. </p>
<pre><code class="language-python">@public
def initializeFactory(template: address):
    assert self.exchangeTemplate == ZERO_ADDRESS
    assert template != ZERO_ADDRESS
    self.exchangeTemplate = template
</code></pre>
<p>The initializer function is a once-only affair and it is expected to be run immediately after Factory is deployed. It takes the address of the Exchange template, which means the Exchange contract is already deployed at this point.</p>
<p>The two <code>assert</code> statements check that </p>
<ol>
<li><code>exchangeTemplate</code> has not been initialized (thus preventing a second call to <code>initializeFactory</code>)</li>
<li><code>template</code> is a non-zero address </li>
</ol>
<p>If both conditions hold, <code>self.exchangeTemplate = template</code> sets Factory’s <code>exchangeTemplate</code> to the address of the deployed Exchange contract.</p>
<p><a href="https://etherscan.io/tx/0x4ef102aebb98c3185396578bcf6f71d0c3c13773caef02514639b9141948245b">This is the original transaction</a> that initialized the factory. Visit the <a href="./exchange.html">Exchange</a> section for relevant info on the transaction that deployed the template.</p>
<pre><code class="language-python">@public
def createExchange(token: address) -&gt; address:
    assert token != ZERO_ADDRESS
    assert self.exchangeTemplate != ZERO_ADDRESS
    assert self.token_to_exchange[token] == ZERO_ADDRESS
    exchange: address = create_with_code_of(self.exchangeTemplate)
    Exchange(exchange).setup(token)
    self.token_to_exchange[token] = exchange
    self.exchange_to_token[exchange] = token
    token_id: uint256 = self.tokenCount + 1
    self.tokenCount = token_id
    self.id_to_token[token_id] = token
    log.NewExchange(token, exchange)
    return exchange
</code></pre>
<p><code>createExchange</code> takes the address of an ERC20 token as the argument and returns the address of the Exchange proxy which functions as the ETH/ERC20 Exchange for that token.</p>
<p>The three <code>assert</code> statements check that:</p>
<ol>
<li>The <code>token</code> address is not zero</li>
<li>The template has been initialized</li>
<li>The Exchange for this particular ERC20 has not yet been created (see <a href="./index.html">Overview</a>)</li>
</ol>
<p><code>exchange: address = create_with_code_of(self.exchangeTemplate)</code> deploys a <a href="https://blog.openzeppelin.com/deep-dive-into-the-minimal-proxy-contract/">minimal proxy contract</a> pointing to the deployed Exchange contract. The name <code>create_with_code_of</code> was a misleading one; it didn’t actually copy the code of a deployed contract. For this reason, the call was later renamed by the Vyper team to <a href="https://vyper.readthedocs.io/en/stable/built-in-functions.html?highlight=create_minimal_proxy#chain-interaction"><code>create_forwarder_to</code></a>.</p>
<p><code>Exchange(exchange).setup(token)</code> initializes the proxy state by calling the Exchange’s <code>setup</code> function and passing the ERC20 token address as the argument. As the result of this approach, there will always only be a single Exchange deployment, which is only used for its logic, and multiple proxies, each holding state of an ETH/ERC20 pair.</p>
<p>Note that this is a common pattern in EVM dev: a contract’s constructor will only be called once, on deployment, so proxies use initializer functions to emulate the work of a constructor. See <a href="./exchange.html">Exchange</a> for the details.</p>
<p><code>self.token_to_exchange[token] = exchange</code> stores the mapping from the ERC20 token address to the address of the Exchange proxy.</p>
<p><code>self.exchange_to_token[exchange] = token</code> stores the mapping from the Exchange proxy address to the ERC20 token address. </p>
<p><code>token_id: uint256 = self.tokenCount + 1</code> stores the new token count in a memory variable, <code>token_id</code>. </p>
<p><code>self.tokenCount = token_id</code> replicates the update to storage variable <code>tokenCount</code>. The reason why storage wasn’t updated immediately with a statement like <code>self.tokenCount = self.tokenCount + 1</code> becomes clear right away:</p>
<p><code>self.id_to_token[token_id] = token</code>, for here we reuse the in-memory variable, avoiding reading from storage. Reading from storage (at the time of the writing) costs 100 gas, and reading from memory costs 3. (Verify this statement): Even with the overhead of setting up an in-memory variable, this saves gas.</p>
<p><code>log.NewExchange(token, exchange)</code> emits a NewExchange event, logging the ERC20 token address and the Exchange proxy address.</p>
<p><code>return exchange</code>
Finally, per function declaration, we return the address of the Exchange proxy to the caller. Note that because we both emit an event and return the address on-chain, we’ve covered all potential use cases where the caller might want to know the address after the transaction has been executed. We can get the address of the newly deployed Exchange proxy both off-chain and when calling <code>createExchange</code> from another smart contract.</p>
<p>Finally, Factory exposes three view functions:</p>
<pre><code class="language-python">@public
@constant
def getExchange(token: address) -&gt; address:
    return self.token_to_exchange[token]
</code></pre>
<p>Returns the Exchange proxy address based on the ERC20 token address. Will return the zero address if no such pairing exists.</p>
<pre><code class="language-python">@public
@constant
def getToken(exchange: address) -&gt; address:
    return self.exchange_to_token[exchange]
</code></pre>
<p>Returns the ERC20 token address based on the Exchange proxy address. Will return the zero address if no such pairing exists.</p>
<pre><code class="language-python">@public
@constant
def getTokenWithId(token_id: uint256) -&gt; address:
    return self.id_to_token[token_id]
</code></pre>
<p>Returns the ERC20 token address based on its identity (serial number).</p>
<h3 id="references"><a class="header" href="#references">References</a></h3>
<div class="footnote-definition" id="vyper"><sup class="footnote-definition-label">1</sup>
<p><a href="https://vyper.readthedocs.io/en/stable/release-notes.html#v0-2-1">Vyper v0.2.1 Release Notes</a></p>
</div>
<div class="footnote-definition" id="events"><sup class="footnote-definition-label">2</sup>
<p><a href="https://vyper.readthedocs.io/en/v0.1.0-beta.4/logging.html">Vyper: Event Logging</a></p>
</div>
<div class="footnote-definition" id="statevars"><sup class="footnote-definition-label">3</sup>
<p><a href="https://vyper.readthedocs.io/en/v0.1.0-beta.4/structure-of-a-contract.html#state-variables">Vyper: State Variables</a></p>
</div>
<div class="footnote-definition" id="address"><sup class="footnote-definition-label">5</sup>
<p><a href="https://vyper.readthedocs.io/en/v0.1.0-beta.4/types.html#id12">Vyper: Address Type</a></p>
</div>
<div class="footnote-definition" id="public"><sup class="footnote-definition-label">4</sup>
<p><a href="https://vyper.readthedocs.io/en/v0.2.0/scoping-and-declarations.html#declaring-public-variables">Vyper: Public Variables</a></p>
</div>
<p><sup class="footnote-reference"><a href="#visibility">6</a></sup> <a href="https://vyper.readthedocs.io/en/v0.1.0-beta.4/structure-of-a-contract.html#functions">Vyper: Function Visibility</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../UniswapV1/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../UniswapV1/exchange.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../UniswapV1/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../UniswapV1/exchange.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
